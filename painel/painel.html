<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Painel ‚Äì DanBurgers</title>
  <link rel="stylesheet" href="../css/style.css">
</head>

<body>

  <h1>üìä Painel DanBurgers</h1>

  <!-- ABAS -->
  <div style="display:flex; gap:10px; margin-bottom:15px;">
    <button onclick="mostrarDelivery()">üì¶ Delivery</button>
    <button onclick="mostrarMesas()">üçΩÔ∏è Mesas</button>
    <button onclick="mostrarCaixa()">üí∞ Caixa</button>
    <button onclick="mostrarHistorico()">üìÅ Hist√≥rico</button>
  </div>

  <!-- DELIVERY -->
  <section id="aba-delivery">
    <h2>Pedidos Delivery</h2>
    <div id="lista-pedidos"></div>
  </section>

  <!-- MESAS -->
  <section id="aba-mesas" style="display:none">
    <h2>Comandas das Mesas</h2>
    <div id="lista-comandas"></div>
  </section>

  <!-- CAIXA -->
  <section id="aba-caixa" style="display:none">
    <h2>üí∞ Caixa</h2>

    <div id="abrir-caixa">
      <h3>Abertura de Caixa</h3>
      <input type="number" id="valor-inicial" placeholder="Valor inicial" />
      <button onclick="abrirCaixa()">Abrir Caixa</button>
    </div>

    <div id="caixa-aberto" style="display:none">
      <p>Valor inicial: R$ <span id="valorInicial">0.00</span></p>

      <hr />

      <h3>Totais do dia</h3>
      <p>Entradas: R$ <span id="totalEntradas">0.00</span></p>
      <p>Sa√≠das: R$ <span id="totalSaidas">0.00</span></p>

      <hr />

      <h3>Resumo por pagamento</h3>
      <p>Dinheiro: R$ <span id="totalDinheiro">0.00</span></p>
      <p>Pix: R$ <span id="totalPix">0.00</span></p>
      <p>Cart√£o: R$ <span id="totalCartao">0.00</span></p>
      <p>Troco: R$ <span id="totalTroco">0.00</span></p>

      <hr />

      <h3>Adicionar despesa</h3>
      <input type="text" id="descricao-despesa" placeholder="Descri√ß√£o" />
      <input type="number" id="valor-despesa" placeholder="Valor" />
      <button onclick="adicionarDespesa()">Adicionar</button>

      <hr />

      <button onclick="fecharCaixa()">Fechar Caixa</button>
    </div>
  </section>

  <!-- HIST√ìRICO -->
  <section id="aba-historico" style="display:none">
    <h2>üìÅ Hist√≥rico de Caixa</h2>
    <div id="lista-historico">
      <p>Carregando hist√≥rico...</p>
    </div>
  </section>

  <div id="area-impressao"></div>

  <!-- CONTROLE DAS ABAS -->
  <script>
    function esconderTodas() {
      document.getElementById("aba-delivery").style.display = "none";
      document.getElementById("aba-mesas").style.display = "none";
      document.getElementById("aba-caixa").style.display = "none";
      document.getElementById("aba-historico").style.display = "none";
    }

    function mostrarDelivery() {
      esconderTodas();
      document.getElementById("aba-delivery").style.display = "block";
    }

    function mostrarMesas() {
      esconderTodas();
      document.getElementById("aba-mesas").style.display = "block";
    }

    function mostrarCaixa() {
      esconderTodas();
      document.getElementById("aba-caixa").style.display = "block";
    }

    window.mostrarHistorico = function () {
      esconderTodas();
      document.getElementById("aba-historico").style.display = "block";
      if (typeof carregarHistoricoCaixa === "function") {
        carregarHistoricoCaixa();
      }
    };
  </script>

  <!-- FLAG GLOBAL -->
  <script>
    window.modalFinalizacaoAberto = false;
  </script>

  <!-- MODAL FINALIZAR VENDA -->
  <div id="modal-finalizar" style="
    display:none;
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    background:rgba(0,0,0,0.5);
    align-items:center;
    justify-content:center;
    z-index:9999;">
    <div style="background:#fff;padding:20px;border-radius:8px;width:320px;">
      <h3>Finalizar Venda</h3>

      <p>Total: R$ <strong id="total-venda">0.00</strong></p>

      <label>Forma de pagamento</label>
      <select id="forma-pagamento">
        <option value="dinheiro">Dinheiro</option>
        <option value="pix">Pix</option>
        <option value="cartao">Cart√£o</option>
      </select>

      <div id="campo-dinheiro" style="margin-top:10px">
        <label>Valor recebido</label>
        <input type="number" id="valor-recebido" />
        <p>Troco: R$ <span id="troco">0.00</span></p>
      </div>

      <div style="margin-top:15px; display:flex; gap:10px;">
        <button onclick="confirmarFinalizacao()">Confirmar</button>
        <button onclick="fecharModal()">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- FUN√á√ïES GLOBAIS DO MODAL -->
  <script>
    let vendaAtual = null;

    window.abrirFinalizacaoVenda = function ({ tipo, id, total, descricao }) {
      window.modalFinalizacaoAberto = true;
      vendaAtual = { tipo, id, total, descricao };

      document.getElementById("total-venda").innerText = Number(total).toFixed(2);
      document.getElementById("valor-recebido").value = "";
      document.getElementById("troco").innerText = "0.00";
      document.getElementById("modal-finalizar").style.display = "flex";
    };

    window.fecharModal = function () {
      window.modalFinalizacaoAberto = false;
      document.getElementById("modal-finalizar").style.display = "none";
    };

    window.confirmarFinalizacao = async function () {
      if (!vendaAtual) return;

      const forma = document.getElementById("forma-pagamento").value;
      const recebido = Number(document.getElementById("valor-recebido").value || 0);
      const total = Number(vendaAtual.total);
      const troco = forma === "dinheiro" ? Math.max(recebido - total, 0) : 0;

      const hoje = new Date().toISOString().slice(0, 10);

      const { data: caixa } = await supabase
        .from("caixa")
        .select("*")
        .eq("data", hoje)
        .eq("status", "aberto")
        .maybeSingle();

      if (!caixa) {
        alert("Abra o caixa antes de finalizar a venda.");
        return;
      }

      await supabase.from("movimentacoes_caixa").insert([{
        caixa_id: caixa.id,
        tipo: "entrada",
        origem: "venda",
        descricao: vendaAtual.descricao,
        valor: total,
        forma_pagamento: forma,
        troco: troco
      }]);

      if (vendaAtual.tipo === "mesa") {
        await supabase.from("comandas")
          .update({ status: "fechada" })
          .eq("id", vendaAtual.id);
      }

      if (vendaAtual.tipo === "delivery") {
        await supabase.from("pedidos")
          .update({ status: "finalizado" })
          .eq("id", vendaAtual.id);
      }

      alert("Venda finalizada com sucesso!");
      fecharModal();

      if (typeof carregarTotais === "function") {
        carregarTotais();
      }
    };
  </script>

  <!-- JS DO PAINEL -->
  <script type="module" src="./painel-delivery.js"></script>
  <script type="module" src="./painel-mesas.js"></script>
  <script type="module" src="./caixa.js"></script>
  <script type="module" src="./historico.js"></script>

</body>
</html>
